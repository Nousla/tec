<!doctype html>
<html>
	<head>
		<title>WebSocket chat</title>
		<link rel="stylesheet" type="text/css" href="stylesheet.css">
		<style>
		  * { margin: 0; padding: 0; box-sizing: border-box; }
		  body { font: 13px Helvetica, Arial; }
		  form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
		  form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
		  form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
		  #messages { list-style-type: none; margin: 0; padding: 0; }
		  #messages li { padding: 5px 10px; }
		  #messages li:nth-child(odd) { background: #eee; }
		</style>
	</head>
	<body>
		<script>
			var commands = new Map();
			commands.set('msg_received', receivedMessage);
			commands.set('name_changed', changedName);
		
			ws = new WebSocket("ws://localhost:3000");

			ws.onopen = function() {
				console.log("connected to server");
			};
			
			ws.onmessage = function (event) {
				var cmd = parseMessage(event.data);
				if(cmd == undefined){
					return;
				}

				if(commands.has(cmd.code)){
					commands.get(cmd.code)(cmd.args);
				}
			};
			
			ws.onclose = function() {
				console.log("disconnected from server");
			};
			
			function parseMessage(msg){
				if(msg.length == 0){
					return;
				}
				
				var msgs = msg.split(" ");
				var cmd = {
					code : msgs[0],
					args : msgs.slice(1,msgs.length)
				}
				
				return cmd;
			}
			
			window.onload = function () {
				document.getElementById("sendForm").onsubmit = function(){
					var sendInput = document.getElementById("sendInput");
					send(ws, 'msg_send', sendInput.value);
					sendInput.value = "";
					return false;
				};
			}
			
			function send(ws, code, args){
				ws.send(code + " " + args);
				console.log(code + " " + args);
			}
			
			function receivedMessage(args){
				var messages = document.getElementById("messages");
				var li = document.createElement("li");
				li.textContent = args.join(" ");
				messages.appendChild(li);
			}
			
			function changedName(args){
				showRoomSelect();
			}
			
			function nicknameOnFocus() {
				var textInput = document.getElementById('textInput_nickname');
				if(textInput.value == 'Enter your nickname') {
					 textInput.value = '';
				}
			}

			function nicknameOnBlur() {
				var textInput = document.getElementById('textInput_nickname');
				if(textInput.value == '') {
					 textInput.value = 'Enter your nickname';
				}
			}
			
			function createUser(){
				var textInput = document.getElementById('textInput_nickname');
				send(ws, 'name_set', textInput.value);
			}
			
			function showRoomSelect() {
				document.getElementById("userSelect").style.display = "none";
				document.getElementById("roomSelect").style.display = "block";
			}
			
			function chatroomOnFocus() {
				var textInput = document.getElementById('textInput_chatroom');
				if(textInput.value == 'Enter Chatroom') {
					 textInput.value = '';
				}
			}

			function chatroomOnBlur() {
				var textInput = document.getElementById('textInput_chatroom');
				if(textInput.value == '') {
					 textInput.value = 'Enter Chatroom';
				}
			}
			
			function showUserSelect() {
				document.getElementById("userSelect").style.display = "block";
				document.getElementById("roomSelect").style.display = "none";
			}
		</script>
		<div id="wrap">
            <div class="content">
                <div class="logo">
                    <p id="logo">WebSocket Chat</p>
                </div>
				
                <div class="selectionBox">
                    <div id="userSelect" style="display: block;">
                        <h1>Please enter nickname:</h1>
                        <div id="button_createUser" onclick="createUser()"><p>Enter</p></div>
                        <input type="text" id="textInput_nickname" value="Enter your nickname" onfocus="nicknameOnFocus()" onblur="nicknameOnBlur()">
                    </div>

                    <div id="roomSelect" style="display: none;">
                        <div id="enterChatroom">
                            <h1>Enter Chatroom</h1>
                            <div id="button_enterChatroom" onclick="chatroomOnBlur()"><p>Enter</p></div>
                            <input type="text" id="textInput_chatroom" value="Enter Chatroom" onfocus="chatroomOnFocus()" onblur="chatroomOnBlur()">
                        </div>
                        <p id="roomSelectOr">OR</p>
                        <div id="createChatroom">
                            <h1>Create Chatroom</h1>
                            <div id="button_createChatroom" onclick="showUserSelect()"><p>+</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		<ul id="messages"></ul>
		<form action="" id="sendForm">
			<input id="sendInput"/>
			<button>Send</button>
		</form>
	</body>
</html>
