<!doctype html>
<html>
    <head>
        <title>JavaScript + WebSocket + Node.js Chat</title>
        <link rel="stylesheet" type="text/css" href="stylesheet.css">
    </head>
    <body>
        <script>
            //testing purposes
            var clientID = Math.floor(Math.random() * (1000000 - 1 + 1)) + 1;
            console.log(clientID);
            var clientNickname = "";
            var currentRoom = 'Lobby';
            var availableChatroomsLength = -1;

            var commands = new Map();
            commands.set('name_changed', changedName);
            commands.set('gotoRoom', gotoRoom);
            commands.set('showAlert', showAlert);

            ws = new WebSocket("ws://localhost:3000");

            ws.onopen = function () {
                console.log("connected to server");
            };

            ws.onmessage = function (event) {
                var cmd = parseMessage(event.data);
                if (cmd == undefined) {
                    return;
                }

                if (commands.has(cmd.code)) {
                    commands.get(cmd.code)(cmd.args);
                }
            };

            ws.onclose = function () {
                console.log("disconnected from server");
            };

            function parseMessage(msg) {
                if (msg.length == 0) {
                    return;
                }

                var msgs = msg.split(" ");
                var cmd = {
                    code: msgs[0],
                    args: msgs.slice(1, msgs.length)
                }

                return cmd;
            }

            window.onload = function () {
                document.getElementById("sendForm").onsubmit = function () {
                    var sendInput = document.getElementById("sendInput");
                    send(ws, 'msg_send', currentRoom + ' ' + sendInput.value);
                    sendInput.value = "";
                    return false;
                };
            }

            function send(ws, code, args) {
                ws.send(code + " " + args);
                console.log(code + " " + args);
            }

            function changedName(args) {
                showRoomSelect();
            }

            function nicknameOnFocus() {
                var textInput = document.getElementById('textInput_nickname');
                if (textInput.value == 'Enter your nickname') {
                    textInput.value = '';
                }
            }

            function joinChatRoom(id) {
                send(ws, 'chatroom_req', id);
                console.log('asking server for chatroom ID');
            }

            function nicknameOnBlur() {
                var textInput = document.getElementById('textInput_nickname');
                if (textInput.value == '') {
                    textInput.value = 'Enter your nickname';
                }
            }

            function createUser() {
                var textInput = document.getElementById('textInput_nickname');
                clientNickname = textInput.value;
                send(ws, 'name_set', textInput.value);
            }

            function showRoomSelect() {
                document.getElementById("userSelect").style.display = "none";
                document.getElementById("roomSelect").style.display = "block";
            }

            function chatroomOnFocus() {
                var textInput = document.getElementById('textInput_chatroom');
                if (textInput.value == 'Enter Chatroom') {
                    textInput.value = '';
                }
            }
            function enterChatroom() {
                var textInput = document.getElementById('textInput_chatroom');
                joinChatRoom(textInput.value);
            }

            function chatroomOnBlur() {
                var textInput = document.getElementById('textInput_chatroom');
                if (textInput.value == '') {
                    textInput.value = 'Enter Chatroom';
                }
            }

            function showUserSelect() {
                document.getElementById("userSelect").style.display = "block";
                document.getElementById("roomSelect").style.display = "none";
            }


            function createChatroom() {
                send(ws, 'createChatroom', clientNickname);
            }

            function showAlert(args) {
                alert(args);
            }

            function gotoRoom(args) {
                document.location.href = "chat/" + args + ".html?ClientID=" + clientID;
            }

        </script>
        <div id="wrap">
            <div class="content">
                <div class="logo">
                    <p id="logo">WebSocket Chat</p>
                </div>

                <div class="selectionBox">
                    <div id="userSelect" style="display: block;">
                        <h1>Who are you?</h1>
                        <div id="button_createUser" onclick="createUser()"><p>Enter</p></div>
                        <input type="text" id="textInput_nickname" value="Enter your nickname" onfocus="nicknameOnFocus()" onblur="nicknameOnBlur()">
                    </div>
                    <div id="roomSelect" style="display: none;">
                        <div id="enterChatroom">
                            <h1>Enter Chatroom</h1>
                            <div id="button_enterChatroom" onclick="enterChatroom()"><p>Enter</p></div>
                            <input type="text" id="textInput_chatroom" value="Enter Chatroom" onfocus="chatroomOnFocus()" onblur="chatroomOnBlur()">
                        </div>
                        <p id="roomSelectOr">OR</p>
                        <div id="createChatroom">
                            <h1>Create Chatroom</h1>
                            <div id="button_createChatroom" onclick="createChatroom()"><p>+</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
